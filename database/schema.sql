-- ============================================================================
-- ä¸ªäººåšå®¢ç³»ç»Ÿæ•°æ®åº“æ¶æ„è®¾è®¡
-- ============================================================================
-- æœ¬æ–‡ä»¶å®šä¹‰äº†åšå®¢ç³»ç»Ÿçš„å®Œæ•´æ•°æ®åº“ç»“æ„ï¼ŒåŒ…æ‹¬ï¼š
-- 1. æ ¸å¿ƒæ•°æ®è¡¨è®¾è®¡
-- 2. æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
-- 3. æ•°æ®å®‰å…¨ç­–ç•¥ï¼ˆRLSï¼‰
-- 4. è‡ªåŠ¨åŒ–è§¦å‘å™¨
-- 5. ä¸šåŠ¡é€»è¾‘å‡½æ•°
-- ============================================================================

-- ============================================================================
-- 1. æ‰©å±•å’ŒåŸºç¡€é…ç½®
-- ============================================================================

-- å¯ç”¨ UUID æ‰©å±•ï¼Œç”¨äºç”Ÿæˆå…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦
-- UUID æ¯”è‡ªå¢ ID æ›´å®‰å…¨ï¼Œæ— æ³•è¢«çŒœæµ‹ï¼Œé€‚åˆå…¬å¼€çš„ API
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- ============================================================================
-- 2. æ ¸å¿ƒæ•°æ®è¡¨è®¾è®¡
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 2.1 æ–‡ç« è¡¨ (articles)
-- ----------------------------------------------------------------------------
-- å­˜å‚¨åšå®¢æ–‡ç« çš„æ ¸å¿ƒä¿¡æ¯ï¼Œæ”¯æŒè‰ç¨¿å’Œå‘å¸ƒçŠ¶æ€
CREATE TABLE articles (
  -- ä¸»é”®ï¼šUUID æ ¼å¼ï¼Œè‡ªåŠ¨ç”Ÿæˆï¼Œé¿å… ID è¢«çŒœæµ‹
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  
  -- æ–‡ç« æ ‡é¢˜ï¼šé™åˆ¶ 255 å­—ç¬¦ï¼Œç”¨äº SEO å’Œæ˜¾ç¤º
  title VARCHAR(255) NOT NULL,
  
  -- URL å‹å¥½çš„æ ‡è¯†ç¬¦ï¼šç”¨äºç”Ÿæˆ SEO å‹å¥½çš„ URL
  -- ä¾‹å¦‚ï¼š/posts/getting-started-with-nextjs
  slug VARCHAR(255) UNIQUE NOT NULL,
  
  -- æ–‡ç« æ­£æ–‡ï¼šæ”¯æŒ Markdown æ ¼å¼ï¼Œæ— é•¿åº¦é™åˆ¶
  content TEXT NOT NULL,
  
  -- æ–‡ç« æ‘˜è¦ï¼šå¯é€‰ï¼Œç”¨äºåˆ—è¡¨é¡µå±•ç¤ºå’Œ SEO æè¿°
  excerpt TEXT,
  
  -- ä½œè€… IDï¼šé¢„ç•™å­—æ®µï¼Œæ”¯æŒå¤šä½œè€…åšå®¢æ‰©å±•
  author_id UUID,
  
  -- åˆ›å»ºæ—¶é—´ï¼šå¸¦æ—¶åŒºçš„æ—¶é—´æˆ³ï¼Œè®°å½•æ–‡ç« åˆ›å»ºæ—¶é—´
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- æ›´æ–°æ—¶é—´ï¼šå¸¦æ—¶åŒºçš„æ—¶é—´æˆ³ï¼Œé€šè¿‡è§¦å‘å™¨è‡ªåŠ¨æ›´æ–°
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- å‘å¸ƒçŠ¶æ€ï¼šfalse=è‰ç¨¿ï¼Œtrue=å·²å‘å¸ƒ
  -- æ”¯æŒå†…å®¹ç®¡ç†å·¥ä½œæµ
  published BOOLEAN DEFAULT false
);

-- ----------------------------------------------------------------------------
-- 2.2 æ ‡ç­¾è¡¨ (tags)
-- ----------------------------------------------------------------------------
-- å­˜å‚¨æ–‡ç« åˆ†ç±»æ ‡ç­¾ï¼Œæ”¯æŒæ ‡ç­¾é¢œè‰²è‡ªå®šä¹‰
CREATE TABLE tags (
  -- ä¸»é”®ï¼šUUID æ ¼å¼
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  
  -- æ ‡ç­¾åç§°ï¼šå”¯ä¸€çº¦æŸï¼Œé¿å…é‡å¤æ ‡ç­¾
  name VARCHAR(100) UNIQUE NOT NULL,
  
  -- æ ‡ç­¾é¢œè‰²ï¼šåå…­è¿›åˆ¶é¢œè‰²å€¼ï¼Œç”¨äºå‰ç«¯æ˜¾ç¤º
  -- é»˜è®¤è“è‰² #3B82F6 (Tailwind CSS blue-500)
  color VARCHAR(7) DEFAULT '#3B82F6',
  
  -- åˆ›å»ºæ—¶é—´ï¼šè®°å½•æ ‡ç­¾åˆ›å»ºæ—¶é—´
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ----------------------------------------------------------------------------
-- 2.3 æ–‡ç« æ ‡ç­¾å…³è”è¡¨ (article_tags)
-- ----------------------------------------------------------------------------
-- å¤šå¯¹å¤šå…³è”è¡¨ï¼Œä¸€ç¯‡æ–‡ç« å¯ä»¥æœ‰å¤šä¸ªæ ‡ç­¾ï¼Œä¸€ä¸ªæ ‡ç­¾å¯ä»¥å…³è”å¤šç¯‡æ–‡ç« 
CREATE TABLE article_tags (
  -- å¤–é”®ï¼šå…³è”æ–‡ç«  IDï¼Œçº§è”åˆ é™¤ä¿è¯æ•°æ®ä¸€è‡´æ€§
  article_id UUID REFERENCES articles(id) ON DELETE CASCADE,
  
  -- å¤–é”®ï¼šå…³è”æ ‡ç­¾ IDï¼Œçº§è”åˆ é™¤é¿å…å­¤ç«‹è®°å½•
  tag_id UUID REFERENCES tags(id) ON DELETE CASCADE,
  
  -- å…³è”åˆ›å»ºæ—¶é—´ï¼šè®°å½•æ ‡ç­¾è¢«æ·»åŠ åˆ°æ–‡ç« çš„æ—¶é—´
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- å¤åˆä¸»é”®ï¼šç¡®ä¿åŒä¸€ç¯‡æ–‡ç« ä¸ä¼šé‡å¤å…³è”åŒä¸€ä¸ªæ ‡ç­¾
  PRIMARY KEY (article_id, tag_id)
);

-- ----------------------------------------------------------------------------
-- 2.4 è¯„è®ºè¡¨ (comments)
-- ----------------------------------------------------------------------------
-- å­˜å‚¨ç”¨æˆ·è¯„è®ºï¼Œæ”¯æŒå®¡æ ¸æœºåˆ¶
CREATE TABLE comments (
  -- ä¸»é”®ï¼šUUID æ ¼å¼
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  
  -- å¤–é”®ï¼šå…³è”æ–‡ç«  IDï¼Œçº§è”åˆ é™¤
  article_id UUID REFERENCES articles(id) ON DELETE CASCADE,
  
  -- è¯„è®ºè€…å§“åï¼šå¿…å¡«ï¼Œç”¨äºæ˜¾ç¤º
  author_name VARCHAR(100) NOT NULL,
  
  -- è¯„è®ºè€…é‚®ç®±ï¼šå¯é€‰ï¼Œç”¨äºé€šçŸ¥å’Œå¤´åƒæ˜¾ç¤º
  author_email VARCHAR(255),
  
  -- è¯„è®ºå†…å®¹ï¼šæ”¯æŒçº¯æ–‡æœ¬æˆ–ç®€å• Markdown
  content TEXT NOT NULL,
  
  -- åˆ›å»ºæ—¶é—´ï¼šè®°å½•è¯„è®ºæäº¤æ—¶é—´
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- å‘å¸ƒçŠ¶æ€ï¼šfalse=å¾…å®¡æ ¸ï¼Œtrue=å·²å‘å¸ƒ
  -- å®ç°è¯„è®ºå®¡æ ¸æœºåˆ¶ï¼Œé˜²æ­¢åƒåœ¾è¯„è®º
  published BOOLEAN DEFAULT false
);

-- ============================================================================
-- 3. æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
-- ============================================================================
-- æ ¹æ®æŸ¥è¯¢æ¨¡å¼åˆ›å»ºç´¢å¼•ï¼Œæå‡æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½

-- æ–‡ç« å‘å¸ƒçŠ¶æ€ç´¢å¼•ï¼šä¼˜åŒ– "è·å–å·²å‘å¸ƒæ–‡ç« " æŸ¥è¯¢
-- ä½¿ç”¨åœºæ™¯ï¼šWHERE published = true
CREATE INDEX idx_articles_published ON articles(published);

-- æ–‡ç« åˆ›å»ºæ—¶é—´å€’åºç´¢å¼•ï¼šä¼˜åŒ– "æŒ‰æ—¶é—´æ’åº" æŸ¥è¯¢
-- ä½¿ç”¨åœºæ™¯ï¼šORDER BY created_at DESCï¼ˆæœ€æ–°æ–‡ç« ä¼˜å…ˆï¼‰
CREATE INDEX idx_articles_created_at ON articles(created_at DESC);

-- æ–‡ç«  slug ç´¢å¼•ï¼šä¼˜åŒ– "é€šè¿‡ URL æŸ¥æ‰¾æ–‡ç« " æŸ¥è¯¢
-- ä½¿ç”¨åœºæ™¯ï¼šWHERE slug = 'article-slug'
CREATE INDEX idx_articles_slug ON articles(slug);

-- è¯„è®ºæ–‡ç« å…³è”ç´¢å¼•ï¼šä¼˜åŒ– "è·å–æ–‡ç« è¯„è®º" æŸ¥è¯¢
-- ä½¿ç”¨åœºæ™¯ï¼šWHERE article_id = 'uuid'
CREATE INDEX idx_comments_article_id ON comments(article_id);

-- è¯„è®ºå‘å¸ƒçŠ¶æ€ç´¢å¼•ï¼šä¼˜åŒ– "è·å–å·²å‘å¸ƒè¯„è®º" æŸ¥è¯¢
-- ä½¿ç”¨åœºæ™¯ï¼šWHERE published = true
CREATE INDEX idx_comments_published ON comments(published);

-- å…¨æ–‡æœç´¢ç´¢å¼•ï¼šæ”¯æŒæ–‡ç« æ ‡é¢˜å’Œå†…å®¹çš„å…¨æ–‡æœç´¢
-- ä½¿ç”¨ PostgreSQL çš„ GIN ç´¢å¼•ï¼Œæ”¯æŒä¸­è‹±æ–‡æœç´¢
-- ä½¿ç”¨åœºæ™¯ï¼šå…¨æ–‡æœç´¢åŠŸèƒ½
CREATE INDEX IF NOT EXISTS articles_search_idx ON articles 
USING gin(to_tsvector('english', title || ' ' || content));

-- ============================================================================
-- 4. è‡ªåŠ¨åŒ–è§¦å‘å™¨
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 4.1 è‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³è§¦å‘å™¨å‡½æ•°
-- ----------------------------------------------------------------------------
-- å½“æ–‡ç« è¢«æ›´æ–°æ—¶ï¼Œè‡ªåŠ¨è®¾ç½® updated_at å­—æ®µä¸ºå½“å‰æ—¶é—´
-- ç¡®ä¿æ—¶é—´æˆ³çš„å‡†ç¡®æ€§ï¼Œæ— éœ€åº”ç”¨å±‚æ‰‹åŠ¨ç»´æŠ¤
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  -- è®¾ç½®æ–°è®°å½•çš„æ›´æ–°æ—¶é—´ä¸ºå½“å‰æ—¶é—´
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ language 'plpgsql';

-- ä¸ºæ–‡ç« è¡¨åˆ›å»ºè§¦å‘å™¨ï¼Œåœ¨æ¯æ¬¡ UPDATE æ“ä½œå‰æ‰§è¡Œ
-- ç¡®ä¿ updated_at å­—æ®µå§‹ç»ˆåæ˜ æœ€åä¿®æ”¹æ—¶é—´
CREATE TRIGGER update_articles_updated_at 
  BEFORE UPDATE ON articles 
  FOR EACH ROW 
  EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- 5. ä¸šåŠ¡é€»è¾‘å‡½æ•°
-- ============================================================================
-- ï¼ˆæš‚æ— ï¼‰

-- ============================================================================
-- 6. è¡Œçº§å®‰å…¨ç­–ç•¥ (Row Level Security, RLS)
-- ============================================================================
-- RLS æ˜¯ PostgreSQL çš„å®‰å…¨ç‰¹æ€§ï¼Œå¯ä»¥åœ¨æ•°æ®åº“å±‚é¢æ§åˆ¶æ•°æ®è®¿é—®æƒé™
-- å³ä½¿åº”ç”¨ä»£ç å­˜åœ¨æ¼æ´ï¼Œä¹Ÿèƒ½ä¿æŠ¤æ•æ„Ÿæ•°æ®

-- å¯ç”¨æ‰€æœ‰è¡¨çš„è¡Œçº§å®‰å…¨
ALTER TABLE articles ENABLE ROW LEVEL SECURITY;
ALTER TABLE tags ENABLE ROW LEVEL SECURITY;
ALTER TABLE article_tags ENABLE ROW LEVEL SECURITY;
ALTER TABLE comments ENABLE ROW LEVEL SECURITY;

-- ----------------------------------------------------------------------------
-- 6.1 æ–‡ç« è®¿é—®ç­–ç•¥
-- ----------------------------------------------------------------------------
-- ç­–ç•¥ï¼šæ™®é€šç”¨æˆ·åªèƒ½æŸ¥çœ‹å·²å‘å¸ƒçš„æ–‡ç« 
-- æœªå‘å¸ƒçš„è‰ç¨¿æ–‡ç« å¯¹å…¬ä¼—ä¸å¯è§ï¼Œåªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®
CREATE POLICY "Everyone can read published articles" ON articles
  FOR SELECT USING (published = true);

-- å¦‚éœ€æ·»åŠ ç®¡ç†å‘˜ç­–ç•¥ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š
-- CREATE POLICY "Admins can read all articles" ON articles
--   FOR ALL USING (auth.jwt() ->> 'role' = 'admin');

-- ----------------------------------------------------------------------------
-- 6.2 æ ‡ç­¾è®¿é—®ç­–ç•¥
-- ----------------------------------------------------------------------------
-- ç­–ç•¥ï¼šæ‰€æœ‰äººéƒ½å¯ä»¥è¯»å–æ ‡ç­¾
-- æ ‡ç­¾æ˜¯å…¬å¼€ä¿¡æ¯ï¼Œç”¨äºæ–‡ç« åˆ†ç±»å’Œç­›é€‰
CREATE POLICY "Everyone can read tags" ON tags
  FOR SELECT USING (true);

-- ----------------------------------------------------------------------------
-- 6.3 æ–‡ç« æ ‡ç­¾å…³è”è®¿é—®ç­–ç•¥
-- ----------------------------------------------------------------------------
-- ç­–ç•¥ï¼šæ‰€æœ‰äººéƒ½å¯ä»¥è¯»å–æ–‡ç« æ ‡ç­¾å…³è”
-- ç”¨äºæ˜¾ç¤ºæ–‡ç« çš„æ ‡ç­¾å’ŒæŒ‰æ ‡ç­¾ç­›é€‰æ–‡ç« 
CREATE POLICY "Everyone can read article tags" ON article_tags
  FOR SELECT USING (true);

-- ----------------------------------------------------------------------------
-- 6.4 è¯„è®ºè®¿é—®ç­–ç•¥
-- ----------------------------------------------------------------------------
-- ç­–ç•¥ï¼šæ™®é€šç”¨æˆ·åªèƒ½æŸ¥çœ‹å·²å‘å¸ƒï¼ˆå·²å®¡æ ¸ï¼‰çš„è¯„è®º
-- å¾…å®¡æ ¸çš„è¯„è®ºå¯¹å…¬ä¼—ä¸å¯è§ï¼Œé˜²æ­¢åƒåœ¾è¯„è®ºæ˜¾ç¤º
-- ä¸æ”¯æŒåŒ¿åç”¨æˆ·è¯„è®º
CREATE POLICY "Everyone can read published comments" ON comments
  FOR SELECT USING (published = true);

-- ============================================================================
-- 7. ç¤ºä¾‹æ•°æ®
-- ============================================================================
-- æ’å…¥ä¸€äº›ç¤ºä¾‹æ•°æ®ç”¨äºå¼€å‘å’Œæµ‹è¯•

-- ----------------------------------------------------------------------------
-- 7.1 ç¤ºä¾‹æ ‡ç­¾æ•°æ®
-- ----------------------------------------------------------------------------
-- æ’å…¥å¸¸ç”¨çš„æŠ€æœ¯æ ‡ç­¾ï¼Œæ¯ä¸ªæ ‡ç­¾ä½¿ç”¨å¯¹åº”çš„å“ç‰Œé¢œè‰²
INSERT INTO tags (name, color) VALUES 
  ('JavaScript', '#F7DF1E'),    -- JavaScript å®˜æ–¹é»„è‰²
  ('React', '#61DAFB'),         -- React å®˜æ–¹è“è‰²
  ('Next.js', '#000000'),       -- Next.js å®˜æ–¹é»‘è‰²
  ('TypeScript', '#3178C6'),    -- TypeScript å®˜æ–¹è“è‰²
  ('CSS', '#1572B6'),           -- CSS å®˜æ–¹è“è‰²
  ('Node.js', '#339933');       -- Node.js å®˜æ–¹ç»¿è‰²

-- ----------------------------------------------------------------------------
-- 7.2 ç¤ºä¾‹æ–‡ç« æ•°æ®
-- ----------------------------------------------------------------------------
-- æ’å…¥ä¸¤ç¯‡ç¤ºä¾‹æ–‡ç« ï¼Œå±•ç¤ºä¸åŒçš„å†…å®¹ç±»å‹
INSERT INTO articles (title, slug, content, excerpt, published) VALUES 
  (
    'Welcome to My Blog',
    'welcome-to-my-blog',
    '# Welcome to My Blog

This is my first blog post! I''m excited to share my thoughts and experiences with you.

## About This Blog

This blog is built with Next.js, TypeScript, and Supabase. It features:

- Server-side rendering
- Static site generation
- Real-time comments
- Tag-based categorization

Stay tuned for more content!',
    'Welcome to my new blog built with Next.js and Supabase.',
    true  -- å·²å‘å¸ƒçŠ¶æ€
  ),
  (
    'Getting Started with Next.js',
    'getting-started-with-nextjs',
    '# Getting Started with Next.js

Next.js is a powerful React framework that makes building web applications a breeze.

## Key Features

- **Server-side Rendering**: Improve SEO and initial page load
- **Static Site Generation**: Pre-render pages at build time
- **API Routes**: Build full-stack applications
- **Image Optimization**: Automatic image optimization

Let''s explore these features in detail...',
    'Learn the basics of Next.js and its powerful features.',
    true  -- å·²å‘å¸ƒçŠ¶æ€
  );

-- ----------------------------------------------------------------------------
-- 7.3 ç¤ºä¾‹æ–‡ç« æ ‡ç­¾å…³è”
-- ----------------------------------------------------------------------------
-- ä¸ºç¤ºä¾‹æ–‡ç« æ·»åŠ ç›¸å…³æ ‡ç­¾
-- ä½¿ç”¨ SELECT å­æŸ¥è¯¢ç¡®ä¿å¼•ç”¨çš„æ–‡ç« å’Œæ ‡ç­¾ç¡®å®å­˜åœ¨
INSERT INTO article_tags (article_id, tag_id) 
SELECT a.id, t.id 
FROM articles a, tags t 
WHERE (a.slug = 'welcome-to-my-blog' AND t.name IN ('Next.js', 'TypeScript'))
   OR (a.slug = 'getting-started-with-nextjs' AND t.name IN ('Next.js', 'React'));

-- ============================================================================
-- æ¶æ„è®¾è®¡æ€»ç»“
-- ============================================================================
-- 
-- 1. ğŸ”’ å®‰å…¨æ€§è®¾è®¡
--    - UUID ä¸»é”®é˜²æ­¢ ID æšä¸¾æ”»å‡»
--    - RLS ç­–ç•¥æ§åˆ¶æ•°æ®è®¿é—®æƒé™
--    - è‰ç¨¿/å‘å¸ƒçŠ¶æ€æ§åˆ¶å†…å®¹å¯è§æ€§
--    - è¯„è®ºå®¡æ ¸æœºåˆ¶é˜²æ­¢åƒåœ¾å†…å®¹
--
-- 2. ğŸš€ æ€§èƒ½ä¼˜åŒ–
--    - é’ˆå¯¹æŸ¥è¯¢æ¨¡å¼çš„ç´¢å¼•è®¾è®¡
--    - å…¨æ–‡æœç´¢ç´¢å¼•æ”¯æŒå†…å®¹æ£€ç´¢
--    - å¤åˆä¸»é”®ä¼˜åŒ–å…³è”æŸ¥è¯¢
--    - çº§è”åˆ é™¤ä¿è¯æ•°æ®ä¸€è‡´æ€§
--
-- 3. ğŸ”„ å¯ç»´æŠ¤æ€§
--    - è§¦å‘å™¨è‡ªåŠ¨ç»´æŠ¤æ—¶é—´æˆ³
--    - æ•°æ®åº“å‡½æ•°å°è£…ä¸šåŠ¡é€»è¾‘
--    - æ¸…æ™°çš„è¡¨å…³ç³»å’Œçº¦æŸ
--    - è¯¦ç»†çš„æ³¨é‡Šæ–‡æ¡£
--
-- 4. ğŸ¯ æ‰©å±•æ€§
--    - å¤šä½œè€…æ”¯æŒï¼ˆauthor_id å­—æ®µï¼‰
--    - çµæ´»çš„æ ‡ç­¾ç³»ç»Ÿ
--    - å¯æ‰©å±•çš„è¯„è®ºåŠŸèƒ½
--    - é¢„ç•™äº†ç”¨æˆ·è®¤è¯é›†æˆæ¥å£
--
-- ============================================================================ 